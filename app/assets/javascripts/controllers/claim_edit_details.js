angular.module("moBilling.controllers.claimEditDetails", [])

    .controller("ClaimEditDetailsController", function ($scope, detailsGenerator) {
        $scope.claim.details || ($scope.claim.details = []);

        $scope.add = function (attributes) {
            $scope.claim.details.push(attributes || {});
        };

        $scope.remove = function (detail) {
            var index = $scope.claim.details.indexOf(detail);

            $scope.claim.details.splice(index, 1);
        };

        function removeAutogenerated() {
            $scope.claim.details = $scope.claim.details.filter(function (detail) {
                return !detail.autogenerated;
            });
        }

        function sort() {
            $scope.claim.details.sort(function (a, b) {
                if (!a.day) {
                    return 1;
                }

                if (!b.day) {
                    return -1;
                }

                return new Date(a.day) - new Date(b.day);
            });
        }

        $scope.generate = function () {
            removeAutogenerated();
            $scope.claim.details = $scope.claim.details.concat($scope.generated);
            sort();
        };

        $scope.$watchGroup([
            "claim.admission_on",
            "claim.first_seen_on",
            "claim.last_seen_on",
            "claim.most_responsible_physician",
            "claim.consult_type",
            "claim.consult_premium_visit",
            "claim.consult_premium_travel",
            "claim.icu_transfer",
            "claim.last_seen_discharge"
        ], function () {
            $scope.generated = detailsGenerator($scope.claim);
        });

        $scope.isGenerateVisible = function () {
            return !angular.equals($scope.generated, $scope.claim.details.filter(function (detail) {
                return detail.autogenerated;
            }));
        };

        // WARNING! `$digest already in progress` AHEAD!
        // workaround for setting the date before the first date
        $scope.$watch("claim.details", function () {
            setTimeout(sort, 100);
        }, true);
    });
