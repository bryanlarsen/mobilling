angular.module("moBilling.controllers.claimEditDetails", [])

    .controller("ClaimEditDetailsController", function ($scope, detailsGenerator) {
        $scope.claim.details || ($scope.claim.details = []);

        $scope.add = function (attributes) {
            $scope.claim.details.push(angular.extend({ autogenerated: false }, attributes));
        };

        $scope.remove = function (detail) {
            var index = $scope.claim.details.indexOf(detail);

            $scope.claim.details.splice(index, 1);
        };

        function removeAutogenerated() {
            $scope.claim.details = $scope.claim.details.filter(function (detail) {
                return !detail.autogenerated;
            });
        }

        $scope.generate = function () {
            removeAutogenerated();
            $scope.claim.details = $scope.claim.details.concat($scope.generated);
        };

        $scope.$watchGroup([
            "claim.admission_on",
            "claim.first_seen_on",
            "claim.last_seen_on",
            "claim.most_responsible_physician",
            "claim.consult_type",
            "claim.consult_premium_visit",
            "claim.consult_premium_travel",
            "claim.icu_transfer",
            "claim.last_seen_discharge"
        ], function () {
            $scope.generated = detailsGenerator($scope.claim);
        });

        $scope.isGenerateVisible = function () {
            var existing = $scope.claim.details.filter(function (detail) {
                return detail.autogenerated;
            });

            return !angular.equals($scope.generated, existing);
        };
    });
